name: Send PR Data on Close

on:
  pull_request:
    types: [closed]

jobs:
  send-pr-data:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Obtener comentarios del PR
        id: comments
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });
            return {
              comments: comments.map(c => ({
                user: c.user.login,
                body: c.body
              }))
            }

      - name: Guardar en Notion
        run: |
          curl -X POST "https://api.notion.com/v1/pages" \
            -H "Authorization: Bearer ${{ secrets.NOTION_TOKEN }}" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d '{
              "parent": { "database_id": "261a14b248a080a1877ed22560259d54" },
              "properties": {
                "PR Number": { "number": '${{ github.event.pull_request.number }}' },
                "Title": { "title": [{ "text": { "content": "${{ github.event.pull_request.title }}" }}] },
                "Merged By": { "rich_text": [{ "text": { "content": "${{ github.event.pull_request.merged_by.login }}" }}] },
                "Comments": { "rich_text": [{ "text": { "content": ${{ toJSON(steps.comments.outputs.result) }} }}] }
              }
            }'
